- if @discerner_search.persisted?    
  #messages
  %div.discerner_search_name
    %b Search name:
    %span.discerner_search_name
      = @discerner_search.name || '[No name specified]'
    %span.discerner_search_name_edit
      = link_to 'Edit', '#', :class => "edit_link icon_link"
      
  %div.discerner_search_dictionary
    %b Dictionary:
    %span{ :class => "#{@discerner_search.dictionary.css_class_name}"}
      #{@discerner_search.dictionary.name}

= form_for @discerner_search, :html => { :id => 'search' } do |f|
  = f.hidden_field :username, :value => discerner_user.username unless discerner_user.blank?
  - @discerner_searchParametersTemplate = generate_nested_attributes_template(f, :search_parameters, 'search_parameter')
  - unless @discerner_search.persisted?   
    %div.discerner_search_name
      = f.label :name, "Search name"
      = f.text_field :name
        
    %div.discerner_search_dictionary
      - if dictionary_options.length > 1
        = f.label :dictionary_id
        = f.select :dictionary_id, dictionary_options, :include_blank => true
      - else
        %b Dictionary:
        = f.hidden_field :dictionary_id, :value => dictionary_options.last[1]
        %span{ :class => "#{dictionary_options.last[2][:css_class_name]}"}
          #{dictionary_options.last[0]}
            
  %table{ :class => 'records search_parameters' }
    %thead
      %tr
        %th.criteria{ :colspan => "3" }
          Criteria
        %th.selections{ :colspan => "2" }
          Selections
        %th
    %tbody.nested_records_search_parameters
      = f.fields_for :search_parameters, f.object.search_parameters.order(:display_order) do |search_parameter|
        = render :partial => 'search_parameter_fields', :locals => { :f => search_parameter }      
    %tfoot
      %tr
        %td{ :colspan => '3', :class => 'add_search_parameters_link' }
          = link_to_add_fields "Add criteria", :search_parameters
          %span.discerner_dictionary_required_message
            Select dictionary in order to add search criteria

  .buttons
    = submit_tag 'Search', :class => "button-discerner negative"
    = link_to 'Clear', new_search_path, :class => "button-discerner negative"

:javascript
  $(function () {
    var searchParametersTemplate = '#{@discerner_searchParametersTemplate}',
    parametersUrl = decodeURIComponent('#{parameter_url(':question_id', :format => 'json')}'),
    renameUrl = '#{@discerner_search.persisted? ? rename_search_path(@discerner_search) : ""}',
    yearRange = '#{DateTime.now.year - 100}:#{DateTime.now.year}'
    searchUI = new Discerner.Search.UI({ 
      searchParametersTemplate: searchParametersTemplate, 
      parametersUrl: parametersUrl, 
      yearRange: yearRange,
      renameUrl: renameUrl })
  });